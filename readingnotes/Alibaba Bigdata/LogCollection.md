### 浏览器的页面日志采集

#### 基本原理

1. 用户在浏览器内访问网址

2. 用户浏览器向服务器发起HTTP请求
> - 请求行（Http Request Line）
> - 请求报头（Http Message Header）：包括表明用户身份的Cookie 信息
> - 请求正文（Http Message Body）：通常是空的

3. 服务器接收并解析请求，发出HTTP响应
> - 状态行：标识对此处HTTP请求的处理结果，eg. 200表示成功响应，400表示所请求资源在服务器端没有被找到
> - 响应报头：生成、检查Cookie
> - 响应正文（Http Message Body）：HTML文件、图片、JS脚本、CSS等

4. 浏览器接收到HTTP响应，按照获得的HTML文档规范解析文档，将渲染渲染在浏览器屏幕上
> - 采集日志的工作，就是发生在第4步！
> - ==基本原理：在HTML文档内的适当位置增加一个日志采集节点，当浏览器解析到这个节点时，触发HTTP 请求到日志采集服务器==
> - 日志采集过程：采集->发送->收集->解析存档

#### 采集过程

- 客户端日志采集
> 在HTML文件中植入JavaScript 脚本进行日志采集。可以在开发页面时植入，也可以在业务服务器响应业务请求时动态执行。

- 客户端日志发送：
> 通过HTTP协议与日志服务器通信，通常放在HTTP日志请求的请求行

- 服务端日志收集
> 立即发回HTTP请求成功的信息，将日志内容写入日志缓冲区（eg 处理日志的消息队列），完成此条日志的收集。

- 服务端日志解析存档
> 日志解析程序从日志缓冲区读取日志并解析（通常伴随着转义、解码），转存为标准的日志文件，供后端程序进一步加工处理。

#### 页面交互日志采集
上面的采集过程可用于PV,UV等指标的日志采集。然而，页面交互通常不会触发浏览器加载新页面，因此其日志采集方法不同于上述方法。

- 根据业务方需求，生成交互日志采集代码
- 将代码植入目标页面，将采集代码与需要监测的交互行为绑定
- 用户发生指定行为，采集代码和正常交互代码一起被触发和执行
- 采集动作完成后，将日志通过HTTP协议发回给日志服务器

#### 日志清洗与预处理
- 识别流量攻击、网络爬虫、虚假流量
- 数据缺项补正：取值归一，标准化处理，反向补正，处理空值
- 剔除无效数据：排重
- 日志隔离分发

### 无线客户端日志采集

使用自研发的 UserTrack SDK 进行日志采集。根据事件进行日志采集，事件可分类为：
- 页面事件（同前述页面浏览）
- 控件点击事件（同前述页面交互）

#### 页面事件
每个页面事件记录三类信息：
>- 设备及用户基本信息
>- 被访问页面的信息（商品页中的商品ID,店铺信息等）
>- 访问路径（页面来源，来源的来源）

在哪里手动埋点：
>- 页面展现的接口：记录页面被打开时的状态信息
>- 页面退出的接口：被触发后将发送日志
>- 页面扩展信息的接口：在页面退出前被调用，添加店铺ID、店铺类别等参数

透传参数功能：把当前页面收集到的信息，传递给下一个页面，甚至下下个页面的日志中，有利于还原用户行为路径。eg. 搜索“连衣裙”-> 浏览“连衣裙”list页 -> 点击进入商品页

#### 控件点击事件
每个控件点击事件记录两类信息：
>- 设备及用户基本信息
>- 控件所在的页面名称，控件名称，控件的业务参数

#### 其他事件及场景
- 在客户端对多条日志进行聚合后，再一起上传给日志服务器，以减小日志服务器处理请求的压力
- 页面回退行为分析，注意排除干扰，配合栈的深度来识别是否是是回退行为

#### H5 & Native 日志统一
将 H5 日志归到 Native 日志